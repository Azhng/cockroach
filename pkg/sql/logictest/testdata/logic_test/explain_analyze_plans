# LogicTest: 5node

# These tests are different from explain_analyze because they require manual
# data placement.

statement ok
CREATE TABLE kv (k INT PRIMARY KEY, v INT, FAMILY (k, v))

statement ok
INSERT INTO kv SELECT i, i FROM generate_series(1,5) AS g(i);

statement ok
CREATE TABLE kw (k INT PRIMARY KEY, w INT, FAMILY (k, w))

statement ok
INSERT INTO kw SELECT i, i FROM generate_series(1,5) AS g(i)

# Split into 5 parts, each row from each table goes to one node.
statement ok
ALTER TABLE kv SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kw SPLIT AT SELECT i FROM generate_series(1,5) AS g(i)

statement ok
ALTER TABLE kv EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

statement ok
ALTER TABLE kw EXPERIMENTAL_RELOCATE SELECT ARRAY[i], i FROM generate_series(1, 5) as g(i)

# Verify that EXPLAIN ANALYZE (DISTSQL) annotates plans with collected
# statistics.

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kv]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {1}       1
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# Verify data placement.
query TTTI colnames,rowsort
SELECT start_key, end_key, replicas, lease_holder from [SHOW RANGES FROM TABLE kw]
----
start_key  end_key  replicas  lease_holder
NULL       /1       {5}       5
/1         /2       {1}       1
/2         /3       {2}       2
/3         /4       {3}       3
/4         /5       {4}       4
/5         NULL     {5}       5

# This query verifies stat collection for the tableReader, mergeJoiner, and
# aggregator.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT kv.k, avg(kw.k) FROM kv JOIN kw ON kv.k=kw.k GROUP BY kv.k]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzsmW9P6sgXx5__XsVkHmlusZ1p658mN8HfXXfDDRZXNFn3hphKZ6Ghtuy04DXG974pdSOCzLdlXILGZ1L49PQcznzOCT7Q7O-YerR70j75dkEmMia_nndOyY-TP87axy2fHPvH7as_T8jOL63uRff39i55-uhoujcySDAd7Izu9ka7JTaaku-dlk9Gd6Tjzz5CvpLiffLbeefyjPz_anaxRw2apKHwg1uRUe8HZdSgnBrUpgZ1qEFd2jPoWKZ9kWWpLD7yMANa4U_qWQaNkvEkLy73DNpPpaDeA82jPBbUoxfBTSzORRAKaVrUoKHIgyiehRnL6DaQ983RlBq0Ow6SzCMNswjcmeQeaRaPcRPk_aHISDrJx8XF4lo-GccLlzIRi34eTaP83iPWnlVEyvIgjkke3QqPWBntPRq0RMoE_n3Am3syDLLhy0drMtp77M3uMRDUY4_Gehnvr8j47jljk21nznxlzs_3SWUopAgX7_OlCFzpU6-U71TIgfieRomQJlvomFj8le802ZfdrzIaDMs_n0tnNLle9cRP0Z_kUZqsquBzdew6HXE8GEgxCPJUmsxdKrpBO2WBnr7-Y__q2u9cXPuX7fZOkxUJdi9Pd5q8-Otb59K_ePr7bTM1qEzvMiJFED5xb9dLjl4vqUvKLb2Sdi9Pr1tFUe3i1blIQiFn7USa3GzaG2spt0KRJslrZXq1Qn7aSMcmX-i3xVTc5VRc_VT2X6TCqvuS4Qlh8oZpb6Ev2bo5H1SYEVuaM1-Z8wZnBHsfMwJ0xPyM2H-7GaF2-n9bCZ0ZUbuXwIxgH3FG8OqS4RXEajdMZwslw9bN-bCCWLc0Z74y5w2Klb8PsYKOmBfrwadYa_cSECv_iGK1q0vGriBWp2G6WygZtm7ORxXEuqU585U5b1Cs9vsQK-iIebEefoq1di8BsdofUaxOdck4FcTqNrZQMWzdjF2s1YbJSJCEhJE0Hwq5hdnzldlvULDO-xAs6I15wR59CrZ2LwHBOh9RsOA_EeciG6dJJhZ-Pn79zlZRQREORFnxLJ3IvjiTaX8WpnzZmXGz32tCkeXlu7x80UrKt4oHrA4f6sDM1qK1YnMQm9WoGa8HH-rACzWrS2vF5iA2X6StefolbC3CtjK0o_621DCztGhXh-ZasTmI7SgrDmBXCfN99fe1ryMVNQwOthpGUgG0VmwklQMdqahhcLDVMJIKoLViI6kcKrv0SN2kRzpSUcNIKoAGZ1NNI6kAGsRmS5OzjlVYnclZlwanE9BIDQjXiw43jqXxWWvlUNNo7qtpuHQAXC86MgRbmqEv-pU5akewpSFaRxKARpZAODpsahx5AuEounqDQLTWBgFodFT1dgiE60WHotBaIwCNjqreIoFwvehQFOpdgoFlgmltE4CGotDbJwAORaG3UXCtjYJrbRSABkcV0EgUCNeLjkTBtTYKQIOjCmgkCoTrRYc_ZKg3Cg42Cq61UQAaiQLh6LDpbRQIR9HrbRS9x__9EwAA___-sQhy

# This query verifies stats collection for the hashJoiner, distinct and sorter.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT DISTINCT(kw.w) FROM kv JOIN kw ON kv.k = kw.w ORDER BY kw.w]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzUl19vozgUxd_3U1j3qdWSgg2kKdJI7U6z2oy6yWzSh50d5YEGb4NCIWs7zVRVv_uKZEYM0PpCXUX0Lfz52T72OfeGR5D_JRDAbHg1_HhNNiIhv08nf5Kvw78_X12MxuRifHH15Z8hObocza5nf10dk--v5tej8cdrcrTanmyP99jqnnyajMZktSWTMVndn6zIB5I_J5Pp5XBKfvuyu5qDBWkW8XF4xyUEX4GCBQwscMECDyzwYW7BWmQLLmUm8lced8Ao-gaBY0Gcrjcqvz23YJEJDsEjqFglHAK4Dm8SPuVhxIXtgAURV2Gc7KZZi_guFA_nq3uwYLYOUxmQnp1PPNmogJzny7gJ1WLJJck2ap3fzO-pzTqp3JI84QsV38fqISDOiZPPJFWYJETFdzwgjoT5kwV7ZC_gxwJvHsgylMvy0s4pzJ_muzFuOQT0yXqd4v4LireFYpv-rJl1RjN7UXMxzibNRMQFj0ojzXMSe-WZjfsjlMtPWZxyYdOKVRL-rzo6p8cfRHy73P16qx3j3_hio-IsfWnXih1x27jgMpYqThfKpn5tm996wRaIbCuJ4GH0ndPZoBDkGRyxTjJzXifZf6Vkv7lkv80ZzjKhuLAZrcr59c31vLTefmm9tHnloXittVnPdjtfbVtoPm1QbUuau1pt6YGrLe18tUVcUFTb_jOlR18dDyWoXG1Zc1uzBlF2e7bX-Si30DxoEOWS5q5GmR04yqzzUUZcUET59J1E2W1ua7dBlL2e7Xc-yi00nzWIcklzV6PsHjjKbuejjLigiPLgnUTZa25rr0GU_V7ng9xCsY8HuWdTEqYRoSRTSy46H2nvwJH2Oh9pxA9FpM_eSaSRb_wpl-sslbx61M-O7OTny6NbvveLzDZiwT-LbLGbZn852XG7L5aIS7V_yvYXo3T_KF9gc3hgAlOjqWnfhGaOnqYt9oy1gwcmMDWaurJnLenKntVoVqWdn2m3BDtV2NXCnv60PC3s62f2tTBjerpvEi49jIRLD2PhQmgkXIhqJFynJuHSw0i49DAWLoRGwoWoRsI10Lr0TG_SM5NwUaP-gdCIxxEaMzmGIy7HlGM9xKyJmHURwzZi2EfMGgnVdxKKtBJq1EtorZm0sruexuyup1G7Izhmd0Q5ZvdaI21ldz2N2V1Po3ZHcMzuiHLM7rVuWrb7KWL3WmNpZfdaY2lldz2N2V1Po3ZHcMzuiHLM7rWm2sruehqzu55G7Y7gmN0R5dhnQq2rlv9wU73dWa23aO0-f_rl_wAAAP__AVEKpQ==

# This query verifies stats collection for WITH ORDINALITY and the hashJoiner.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT * FROM kv WITH ORDINALITY AS a, kv WITH ORDINALITY AS b]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMkcFv0zAUxu_8FdY7ATI0SVMOPiViRQsKzWgiwZhycJOnzZprB9upVlX931GSSbRV161wgKPfe7_3vu_zBuxPCQzyaTr9WJDWSPJpnn0hN9PvV2mczEg8i9PrH1Py-iLJi_xr-oY8jr4dBu9X5FtSXJJsfpHM4jQprkmcE06faCxKoKB0jTO-RAvsBnwoKTRGV2itNl1p0w8k9QMwj4JQTeu6ckmh0gaBbcAJJxEYFHwhcY68RjPygEKNjgvZr22MWHKzju5XQCFvuLKMvAMKC-6qO7REt65pHSM-UHBtI3dKE6BgUWLlxEq4NSPee6_bbh2XkjixREY8C-WWwoA8qrOO3yIwf0tf7iAztVBcCrce-fsG_kIoPmDVOqHV82KDc8Tuxh38L3GP_zDu8b-IO3xS7G-NrdKmRoP1nsCyI58bOeL4ktu7z1ooNKNw33HWeYp8GgU0GtMopNGERh9e9mfBsSyC87KYnPNxc7SNVhYPMzm62euCwPoWh2Ctbk2FV0ZX_ZnhmfVcX6jRuqHrD49EDa1O4C7sn4TDPdg_hIOT8Pj05fEZl4NDODwJTw4ul9tXvwIAAP__uyD70A==

# Verify that EXPLAIN ANALYZE on an unsupported query doesn't return an error.
statement ok
EXPLAIN ANALYZE (DISTSQL) SHOW QUERIES;

statement ok
EXPLAIN ANALYZE (DISTSQL) EXPLAIN SELECT 1

# This query verifies support for zeroNode in DistSQL.
query B
SELECT automatic FROM [EXPLAIN (DISTSQL) SELECT sum(k) FROM kv WHERE FALSE]
----
true

# This query verifies stat collection for the tableReader and windower.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT avg(k) OVER () FROM kv]
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJzMlE2P2jAQhu_9FdacQDLNdw8-gdq0QqKwBbT9WOXgjUc0wsSp7bC7Qvz3KgnqFsS2rjjQo8d-8vrxRLMD80MCg0U6Sd8uSa0leT-ffSR36ZebyWg8JaPpaPL1W0p678aL5eLTpE8OR_l21Vv3yew2nZNev6PW2wwolErglG_QALuDACiEQCECCjFQSCCjUGmVozFKN0d2LTAWj8B8CkVZ1bYpZxRypRHYDmxhJQKDJb-XOEcuUHs-UBBoeSHbmEoXG66fhustUFhUvDSMDLwmeFZbRobNNe65zb-jIaq2VVNsarau5EnJoMTcFtvCPjHiv_abJGO5lMQWG2TEN5DtKXTI4abG8hUCC_b0BZtnibpUWqBGcSSQ7c_4fi5KoR5Qe8mx7Oj2Q28Y9H_JhW5yyQty-Ih5bQtVPgtS0OrBEI1cHDi3BwiPHiBwb2fw93Z64cCLrtrQ0N0ndPCJBl58VZ_I3Sdy8IkH7Y96PZ_Y3Sd28EkG_834OGMzR1Op0uDJGDn_Zb8ZLyhW2M0io2qd441WeRvTLWct1xYEGtvtBt1iXLZb7QV_h4M_wm-OYP8UDi9Jji6B40vg5J_gbP_qZwAAAP__X7dggw==

# Very simple query to make it easier to spot regressions when rewriting results
# in test files.
query T
SELECT url FROM [EXPLAIN ANALYZE (DISTSQL) SELECT k FROM kv WHERE k = 0];
----
https://cockroachdb.github.io/distsqlplan/decode.html#eJyMkM9L-0AQxe_fv2KY70VhNZvrgtCiEQOxrUnBHyWHbTLUkG027k6KpeR_lyS9KAge5zPvvd03J_QfBhVmURLdrqFzBu7T5SNsopdVMo8XMF_Mk9e3CC7u4mydPSWXcJbWk7A-wPNDlEZQww3IHAU2tqSF3pNHtcEQc4GtswV5b92ATqMgLj9RSYFV03Y84FxgYR2hOiFXbAgVrvXWUEq6JBdIFFgS68qMsa2r9todZ_UBBWatbryCQF4FMviPApcdK5iFKHCruXgnD7bjdoBDDHet-YE8GSq4OlR8VCCv5chYGwNc7UmB9Jj3AifL-bee9Y5Qhb34e6OUfGsbT9_K_JYs-1wglTuaruZt5wpaOVuMz0zjcvSNoCTP0zachriZVn3e__sKAAD__xmzmlc=
